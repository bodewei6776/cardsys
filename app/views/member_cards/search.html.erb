<div class="w96">
  <div class=" r_bt" >
    <div class=" r_bt_l" >
      <div class=" r_bt_l_a" ></div>
      <div class=" r_bt_l_c fb white" >会员查询</div>
    </div>

    <div class=" r_bt_r" ></div>
  </div>
  <div class="soso">
    <form method="post" action="/member_cards/search" class="form-profile" id="search_form">
      <div class="w95">
        会员名称：
        <label for="name">
          <input type="text" name="member_name" maxlength="24" tabindex="1" value="<%=params[:member_name] %>" class="inputtext" autocomplete="/members/autocomplete_name" />
        </label>&nbsp;&nbsp;&nbsp;&nbsp;

        <input type="submit" name="search" id="search_member" class="inputsubmit" value="查询"  tabindex="10" />
        <%unless @member_cards.blank? %>
          <br>
          <div id='member_cards_list'>
          <label for="card_id">选择充值的会员卡号：</label>
          <% for member_card in @member_cards %>
            <% unless member_card.card_serial_num.blank? %>
              <%= radio_button_tag("card_serial_num", member_card.card_serial_num, (member_card.card_serial_num == @serial_num)? true : false)%><%=member_card.card_serial_num%>
            <%end%>
          <%end%>
          </div>
        <%end%>
      </div>
    </form>
  </div>
  <% if @member_card %>
  <div class="fform">
    <div class="fformbox" >
    <div id="errorExplanation" style='display:none;'><h2>错误</h2><p><%= @notice %></p></div>
      <div class="fformbox_bt"><p>会员卡充值</p></div>

      <div class="fformbox_nr">
        <ul>
          <li>
            <div class="w1">所属会员：</div>
            <div class="w2">
              <%=   @member_card.member.name rescue "未知"%>
            </div>
            <div class="w1">卡类型：</div>
            <div class="w2">
              <%= display_card_type_desc(@member_card.nil? ? nil : @member_card.card) %>
            </div>
          </li>
        </ul>
        <ul>
          <li>
            <div class="w1">卡内金额：</div>
            <div class="w2">
              <%= @member_card.left_fee%>　元
            </div>

            <div class="w1">充金额：</div>
            <div class="w2">
              <input name="fee" id="fee" value="" onchange="javascript:checkNum(this.value)"/>
            </div>


                      </li>
        </ul>
        <ul>
          <li>
            <div class="w1">有效期：</div>
            <div class="w2">
              <% time = @member_card.expire_date %>
              <%= time.blank? ? "未知" : time.strftime("%Y-%m-%d")%>
            </div>
            <div class="w1">修改有效期：</div>
            <div class="w2">
              <input name="expire_date" id="expire_date" value=""/>
            </div>
          </li>
        </ul>
        <ul>
          <li>
<div class="w1">卡内次数：</div>
            <div class="w2">
              <%= @member_card.left_times%> 次
            </div>

            <div class="w1">充次数：</div>
            <div class="w2">
              <input name="times" id="times" value="" onchange="javascript:checkNum(this.value)"/>
            </div>
          </li>
        </ul>

   <ul>
          <li>
            <div class="w1">充值人：</div>
            <div class="w2">
              <input name="recharge_person" id="recharge_person" value="<%= current_user.login%>" type='textfield'/>
            </div>
            <div class="w1">密码：</div>
            <div class="w2">
              <input name="recharge_password" id="recharge_password" value="" type='password'/>
            </div>
          </li>
        </ul>

      </div>
    </div>
    <div class="h10"></div>
    <div class="input_bd">
      <button class="submit1 hand" type="button" onclick="recharge_submit(<%=@member_card.id%>, 1);">修改</button>
    </div>
    <div class=" clear"></div>
  </div>
  <%end%>
  <div class="h10"></div>
</div>
<script type="text/javascript">



  $(".member_card_detail").colorbox({width:"80%", height:"80%", iframe:false});
  $(".member_card_recharge").colorbox({width:"50%", height:"40%", iframe:false});

  $(function() {
    $("#expire_date").datepicker({dateFormat: 'yy-mm-dd'});
  });
  function recharge_submit(card_id, type){    
    var expire_date = $("#expire_date")[0].value;
    if(type == '1'){
      if(!confirm("确定要做此操作？")) return;
    }
    var fee = $("#fee")[0].value;
    var times = $("#times")[0].value;
    var recharge_person = $("#recharge_person").val();
    var recharge_password= $("#recharge_password").val();
    if(""!=fee && !isNumTemp(fee)){
      alert("充值数必须为有效数字！");
      return;
    }
    if(""!=times && !isNumTemp(times)){
      alert("充值数必须为有效数字！");
      return;
    }
    if("" == recharge_person.trim()) { alert("请输入充值人id"); return;}
    if("" == recharge_password.trim()) { alert("请输入充值人密码"); return;}
    $.getJSON("/members/member_card_recharge",
        {'type':'json', 'fee':fee, 'times':times, 'member_card_id':card_id, 'type':type, 
      'expire_date':expire_date,'user':recharge_person,'password':recharge_password},
    function(data){
      $("#errorExplanation").show();
      $("#errorExplanation p").text(data.notice);
      var form = $("form[0]");
      form.attr("action", "/member_cards/search?p=num");
      if(data.result == "1"){
      form.submit();
      }
    });
  }

  $(":radio").click(function(){
    var form = $("form[0]");
    form.attr("action", "/member_cards/search?p=num");
    form.submit();
  });
  function checkNum(k){        
    if(""!=k && !isNumTemp(k)){
      alert("充值数必须为有效数字！");
      $(this)[0].focus();
      return false;
    }
  }
  function isNumTemp(obj){
    return /^[+-]?\d+$/.test(obj);
  }
</script>
